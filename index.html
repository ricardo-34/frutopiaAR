<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .a-enter-vr-button { display: none !important; }
    
    #debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      z-index: 2000;
      max-width: 300px;
    }
    
    #intro-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeInOut 4s ease-in-out forwards;
    }
    
    #intro-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      animation: fadeImage 3s ease-in-out forwards;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
    
    @keyframes fadeImage {
      0% { opacity: 0; }
      30% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }

    #control-buttons {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
  </style>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Debug Info -->
  <div id="debug-info">
    <div>Estado: <span id="status">Iniciando...</span></div>
    <div>Video: <span id="video-status">Cargando...</span></div>
    <div>Marcador: <span id="marker-status">No detectado</span></div>
    <div>Video Dimensiones: <span id="video-dims">-</span></div>
  </div>

  <!-- Animación de intro -->
  <div id="intro-container">
    <img id="intro-image" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/inicio.jpg" alt="Intro Animation">
  </div>

  <!-- Botones de control -->
  <div id="control-buttons">
    <button id="play-pause-btn" class="control-btn"><i class="fas fa-pause"></i></button>
    <button id="restart-btn" class="control-btn"><i class="fas fa-redo"></i></button>
    <button id="mute-btn" class="control-btn"><i class="fas fa-volume-up"></i></button>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/targets.mind; filterMinCF: 0.001; filterBeta: 0.01;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
  >
    <a-assets>
      <video id="video0"
             src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/video.mp4"
             preload="auto" loop playsinline webkit-playsinline crossorigin="anonymous">
      </video>
      <img id="mask0" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/mask1.png" crossorigin="anonymous">
      <img id="frame0" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/frame2.png" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Marcador 0 - VERSION SIMPLIFICADA SIN MASCARA -->
    <a-entity id="target0" mindar-image-target="targetIndex: 0">
      <a-entity id="markerGroup0">
        <!-- Video SIN máscara primero para debug -->
        <a-plane 
          id="plane0" 
          src="#video0"
          width="1.6"
          height="1"
          position="0 0 0"
          material="shader: flat; transparent: false"
        ></a-plane>
        
        <!-- Frame encima -->
        <a-image 
          id="overlay0" 
          src="#frame0" 
          width="1.6"
          height="1"
          position="0 -0.06 0.01"
          material="transparent: true; alphaTest: 0.5"
        ></a-image>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // Debug logger
    function updateDebug(field, value) {
      const elem = document.getElementById(field);
      if (elem) elem.textContent = value;
    }

    // Variable para el video activo
    let activeVideoId = null;

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      updateDebug('status', 'DOM Cargado');
      
      const vid = document.getElementById('video0');
      const target = document.getElementById('target0');
      const markerGroup = document.getElementById('markerGroup0');
      
      // Verificar carga del video
      vid.addEventListener('loadedmetadata', () => {
        const aspect = vid.videoWidth / vid.videoHeight;
        updateDebug('video-dims', `${vid.videoWidth}x${vid.videoHeight} (${aspect.toFixed(2)})`);
        updateDebug('video-status', 'Video cargado');
        
        // Configurar dimensiones basadas en el aspect ratio
        const plane = document.getElementById('plane0');
        const overlay = document.getElementById('overlay0');
        
        plane.setAttribute('width', aspect);
        plane.setAttribute('height', 1);
        overlay.setAttribute('width', aspect);
        overlay.setAttribute('height', 1);
        
        // Escala global más pequeña para empezar
        markerGroup.setAttribute('scale', '1.5 1.5 1.5');
      });
      
      vid.addEventListener('error', (e) => {
        updateDebug('video-status', 'ERROR: ' + e.message);
      });
      
      vid.addEventListener('canplay', () => {
        updateDebug('video-status', 'Video listo para reproducir');
      });
    });

    // Eventos de detección del marcador
    document.querySelector('a-scene').addEventListener('renderstart', () => {
      updateDebug('status', 'Escena iniciada');
      
      const vid = document.getElementById('video0');
      const target = document.getElementById('target0');
      
      target.addEventListener('targetFound', () => {
        updateDebug('marker-status', '✓ DETECTADO');
        vid.play().then(() => {
          updateDebug('video-status', 'Reproduciendo');
          activeVideoId = 'video0';
          updateButtonStates();
        }).catch(err => {
          updateDebug('video-status', 'Error play: ' + err.message);
        });
      });
      
      target.addEventListener('targetLost', () => {
        updateDebug('marker-status', 'No detectado');
        vid.pause();
        activeVideoId = null;
      });
    });

    // Activar audio
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const vid = document.getElementById('video0');
        vid.muted = false;
      }, 1000);
    });

    // Gestión de intro
    document.addEventListener('DOMContentLoaded', () => {
      const introContainer = document.getElementById('intro-container');
      const controlButtons = document.getElementById('control-buttons');
      
      setTimeout(() => {
        introContainer.style.display = 'none';
        controlButtons.style.opacity = '1';
      }, 4000);
    });

    // Funciones de control
    function getActiveVideo() {
      return activeVideoId ? document.getElementById(activeVideoId) : null;
    }

    function updateButtonStates() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;

      const playPauseBtn = document.getElementById('play-pause-btn');
      playPauseBtn.innerHTML = activeVideo.paused ? 
        '<i class="fas fa-play"></i>' : 
        '<i class="fas fa-pause"></i>';

      const muteBtn = document.getElementById('mute-btn');
      muteBtn.innerHTML = activeVideo.muted ? 
        '<i class="fas fa-volume-mute"></i>' : 
        '<i class="fas fa-volume-up"></i>';
    }

    // Manejadores de botones
    document.getElementById('play-pause-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;

      if (activeVideo.paused) {
        activeVideo.play();
        this.innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        activeVideo.pause();
        this.innerHTML = '<i class="fas fa-play"></i>';
      }
    });

    document.getElementById('restart-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;
      
      activeVideo.currentTime = 0;
      activeVideo.play();
      document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
    });

    document.getElementById('mute-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;
      
      activeVideo.muted = !activeVideo.muted;
      this.innerHTML = activeVideo.muted ? 
        '<i class="fas fa-volume-mute"></i>' : 
        '<i class="fas fa-volume-up"></i>';
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .a-enter-vr-button { display: none !important; }
    
    /* Animación intro */
    #intro-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeInOut 4s ease-in-out forwards;
      overflow: hidden;
    }
    
    #intro-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      animation: fadeImage 3s ease-in-out forwards;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
    
    @keyframes fadeImage {
      0% { opacity: 0; }
      30% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Botones de control */
    #control-buttons {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    
    .control-btn:active {
      transform: scale(0.95);
    }
  </style>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Animación de intro -->
  <div id="intro-container">
    <img id="intro-image" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/inicio.jpg" alt="Intro Animation">
  </div>

  <!-- Botones de control -->
  <div id="control-buttons">
    <button id="play-pause-btn" class="control-btn"><i class="fas fa-pause"></i></button>
    <button id="restart-btn" class="control-btn"><i class="fas fa-redo"></i></button>
    <button id="mute-btn" class="control-btn"><i class="fas fa-volume-up"></i></button>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/targets.mind; filterMinCF: 0.001; filterBeta: 0.01;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
  >
    <a-assets>
      <video id="video0"
             src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/video.mp4"
             preload="auto" loop playsinline webkit-playsinline crossorigin="anonymous">
      </video>
      <img id="mask0" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/mask1.png" crossorigin="anonymous">
      <img id="frame0" src="https://cdn.jsdelivr.net/gh/ricardo-34/frutopiaAR@main/assets/frame2.png" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Marcador 0 -->
    <a-entity id="target0" mindar-image-target="targetIndex: 0">
      <a-entity id="markerGroup0">
        <!-- Video con máscara -->
        <a-plane id="plane0" src="#video0" video-mask="mask: #mask0"></a-plane>
        <!-- Frame/Marco encima -->
        <a-image id="overlay0" src="#frame0" material="transparent: true; alphaTest: 0.5"></a-image>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // Componente para aplicar máscara al video
    AFRAME.registerComponent('video-mask', {
      schema: {
        mask: { type: 'selector' }
      },

      init: function() {
        const el = this.el;
        el.addEventListener('loaded', () => {
          this.setupMask();
        });
      },

      setupMask: function() {
        const el = this.el;
        const maskImg = this.data.mask;
        const videoSrc = el.getAttribute('src');
        const video = document.querySelector(videoSrc);

        if (!video || !maskImg) {
          console.error('Video o máscara no encontrados');
          return;
        }

        const maskTexture = new THREE.TextureLoader().load(maskImg.src);
        maskTexture.needsUpdate = true;
        
        const videoTexture = new THREE.VideoTexture(video);
        videoTexture.minFilter = THREE.LinearFilter;
        videoTexture.magFilter = THREE.LinearFilter;

        setTimeout(() => {
          const mesh = el.getObject3D('mesh');
          if (!mesh) return;

          const config = configs.find(c => c.planeId === el.id);
          if (!config) return;

          const material = new THREE.ShaderMaterial({
            uniforms: {
              videoTexture: { value: videoTexture },
              maskTexture: { value: maskTexture },
              maskScale: { value: config.maskScale },
              maskOffset: { value: new THREE.Vector2(config.maskPositionX, config.maskPositionY) }
            },
            vertexShader: `
              varying vec2 vUv;
              void main() {
                vUv = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
              }
            `,
            fragmentShader: `
              uniform sampler2D videoTexture;
              uniform sampler2D maskTexture;
              uniform float maskScale;
              uniform vec2 maskOffset;
              varying vec2 vUv;
              
              void main() {
                vec4 videoColor = texture2D(videoTexture, vUv);
                vec2 centeredUv = vUv - 0.5;
                vec2 scaledUv = (centeredUv / maskScale) + 0.5;
                vec2 finalUv = scaledUv - maskOffset;
                vec4 maskColor = texture2D(maskTexture, finalUv);
                float alpha = maskColor.r;
                gl_FragColor = vec4(videoColor.rgb, alpha);
              }
            `,
            transparent: true,
            side: THREE.DoubleSide
          });

          mesh.material = material;
          mesh.material.needsUpdate = true;
        }, 100);
      }
    });

    // Configuración del marcador
    const configs = [
      { 
        vidId: 'video0', 
        planeId: 'plane0', 
        overlayId: 'overlay0',
        targetId: 'target0',
        markerGroupId: 'markerGroup0',

        // Escala global (ajusta este valor según necesites)
        globalScale: 2.4,
        globalPositionX: 0,
        globalPositionY: 0,
        globalPositionZ: 0,
        
        // Video
        videoScale: 1,
        videoPositionX: 0,
        videoPositionY: 0,
        videoPositionZ: 0.02,
        
        // Frame
        overlayScale: 1,
        framePositionX: 0,
        framePositionY: -0.06,
        framePositionZ: 0.05,
        
        // Mask
        maskScale: 1,
        maskPositionX: 0,
        maskPositionY: 0,

        // Rotación
        rotationMin: 0,
        rotationMax: 20,
        rotationSpeed: 0.5
      }
    ];

    let activeVideoId = null;

    // Configuración de elementos
    configs.forEach((config) => {
      const vid = document.getElementById(config.vidId);
      const plane = document.getElementById(config.planeId);
      const overlay = document.getElementById(config.overlayId);
      const markerGroup = document.getElementById(config.markerGroupId);

      vid.addEventListener('loadedmetadata', () => {
        const aspect = vid.videoWidth / vid.videoHeight;
        
        // Video
        plane.setAttribute('width', aspect);
        plane.setAttribute('height', 1);
        plane.setAttribute('scale', `${config.videoScale} ${config.videoScale} ${config.videoScale}`);
        plane.setAttribute('position', `${config.videoPositionX} ${config.videoPositionY} ${config.videoPositionZ}`);
        
        // Overlay
        overlay.setAttribute('width', aspect);
        overlay.setAttribute('height', 1);
        overlay.setAttribute('scale', `${config.overlayScale} ${config.overlayScale} ${config.overlayScale}`);
        overlay.setAttribute('position', `${config.framePositionX} ${config.framePositionY} ${config.framePositionZ}`);
        
        // Grupo (escala global)
        markerGroup.setAttribute('scale', `${config.globalScale} ${config.globalScale} ${config.globalScale}`);
        markerGroup.setAttribute('position', `${config.globalPositionX} ${config.globalPositionY} ${config.globalPositionZ}`);
        markerGroup.setAttribute('oscillate-rotation', {
          min: config.rotationMin,
          max: config.rotationMax,
          speed: config.rotationSpeed
        });
      });
    });

    // Componente de rotación oscilante
    AFRAME.registerComponent('oscillate-rotation', {
      schema: {
        min: { type: 'number', default: 0 },
        max: { type: 'number', default: 360 },
        speed: { type: 'number', default: 1 }
      },
      init: function() {
        this.direction = 1;
        this.minRad = (this.data.min * Math.PI) / 180;
        this.maxRad = (this.data.max * Math.PI) / 180;
        this.el.object3D.rotation.y = this.minRad;
      },
      tick: function() {
        const speed = this.data.speed * 0.002;
        this.el.object3D.rotation.y += speed * this.direction;
        if (this.el.object3D.rotation.y >= this.maxRad) {
          this.direction = -1;
        } else if (this.el.object3D.rotation.y <= this.minRad) {
          this.direction = 1;
        }
      }
    });

    // Inicialización de la escena
    document.querySelector('a-scene').addEventListener('renderstart', () => {
      configs.forEach(({ vidId }, idx) => {
        const vid = document.getElementById(vidId);
        const targetEl = document.querySelector(`a-entity[mindar-image-target="targetIndex: ${idx}"]`);
        
        targetEl.addEventListener('targetFound', () => {
          vid.play();
          activeVideoId = vidId;
          updateButtonStates();
        });
        
        targetEl.addEventListener('targetLost', () => {
          vid.pause();
          if (activeVideoId === vidId) {
            activeVideoId = null;
          }
        });
      });
    });

    // Activar audio
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        configs.forEach(({vidId}) => {
          document.getElementById(vidId).muted = false;
        });
      }, 1000);
    });

    // Gestión de intro
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        document.getElementById('intro-container').style.display = 'none';
        document.getElementById('control-buttons').style.opacity = '1';
      }, 4000);
    });

    // Funciones de control
    function getActiveVideo() {
      if (!activeVideoId) {
        for (let i = 0; i < configs.length; i++) {
          const targetEl = document.querySelector(`a-entity[mindar-image-target="targetIndex: ${i}"]`);
          if (targetEl && targetEl.object3D.visible) {
            activeVideoId = configs[i].vidId;
            break;
          }
        }
      }
      return activeVideoId ? document.getElementById(activeVideoId) : null;
    }

    function updateButtonStates() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;

      document.getElementById('play-pause-btn').innerHTML = activeVideo.paused ? 
        '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
      document.getElementById('mute-btn').innerHTML = activeVideo.muted ? 
        '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    }

    // Eventos de botones
    document.getElementById('play-pause-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;
      if (activeVideo.paused) {
        activeVideo.play();
        this.innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        activeVideo.pause();
        this.innerHTML = '<i class="fas fa-play"></i>';
      }
    });

    document.getElementById('restart-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;
      activeVideo.currentTime = 0;
      activeVideo.play();
      document.getElementById('play-pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
    });

    document.getElementById('mute-btn').addEventListener('click', function() {
      const activeVideo = getActiveVideo();
      if (!activeVideo) return;
      activeVideo.muted = !activeVideo.muted;
      this.innerHTML = activeVideo.muted ? 
        '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    });
  </script>
</body>
</html>
